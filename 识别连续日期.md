
#### Report Contiguous Dates

Table: `Failed`
```
+--------------+---------+
| Column Name  | Type    |
+--------------+---------+
| fail_date    | date    |
+--------------+---------+
fail_date is the primary key for this table.
This table contains the days of failed tasks.
```

Table: `Succeeded`
```
+--------------+---------+
| Column Name  | Type    |
+--------------+---------+
| success_date | date    |
+--------------+---------+
success_date is the primary key for this table.
This table contains the days of succeeded tasks.
```

A system is running one task every day. Every task is independent of the previous tasks. The tasks can fail or succeed.

Write an SQL query to generate a report of `period_state` for each continuous interval of days in the period from `2019-01-01` to `2019-12-31`.

period_state is 'failed' if tasks in this interval failed or 'succeeded' if tasks in this interval succeeded. Interval of days are retrieved as `start_date` and `end_date`.

Return the result table ordered by `start_date`.

#### Example

```
Input: 
Failed table:
+-------------------+
| fail_date         |
+-------------------+
| 2018-12-28        |
| 2018-12-29        |
| 2019-01-04        |
| 2019-01-05        |
+-------------------+
Succeeded table:
+-------------------+
| success_date      |
+-------------------+
| 2018-12-30        |
| 2018-12-31        |
| 2019-01-01        |
| 2019-01-02        |
| 2019-01-03        |
| 2019-01-06        |
+-------------------+
Output: 
+--------------+--------------+--------------+
| period_state | start_date   | end_date     |
+--------------+--------------+--------------+
| succeeded    | 2019-01-01   | 2019-01-03   |
| failed       | 2019-01-04   | 2019-01-05   |
| succeeded    | 2019-01-06   | 2019-01-06   |
+--------------+--------------+--------------+

```


#### Answer

- 利用date和row number的差值
- 不是date - row_number 
- 用`date_sub(date,interval row_num day)`



```sql
(select 'succeeded' period_state,
    min(success_date) start_date,
    max(success_date) end_date 
from(
    select success_date,
        row_number() over(order by success_date) row_num
    from Succeeded 
) as s 
where success_date between '2019-01-01' and '2019-12-31'
group by date_sub(success_date,interval row_num day)) #group by date_sub

union all 

(select 'failed' period_state,
    min(fail_date) start_date,
    max(fail_date) end_date 
from(
    select fail_date,
        row_number() over(order by fail_date) row_num
    from Failed
) as f 
where fail_date between '2019-01-01' and '2019-12-31'
group by date_sub(fail_date,interval row_num day)) #group by date_sub

order by start_date

```
